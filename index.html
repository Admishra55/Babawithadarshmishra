<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mandir Community ‚Ä¢ Aarti & Bhajan</title>
<link rel="manifest" href="manifest.webmanifest"><meta name="theme-color" content="#ff6b00">
<style>
  :root{--bg:#0b0b0b; --card:#151515; --text:#ffffff; --muted:#b6b6b6; --brand:#ff6b00; --accent:#ffd25a; --border:#282828;}
  [data-theme="light"]{--bg:#f7f7f7; --card:#ffffff; --text:#121212; --muted:#6a6a6a; --brand:#b23a12; --accent:#ffd25a; --border:#eaeaea;}
  [data-theme="saffron"]{--bg:#fff7ea; --card:#fff; --text:#2b1a00; --muted:#8a6a3a; --brand:#ff6b00; --accent:#ffd25a; --border:#ffd6a8;}
  [data-theme="classic"]{--bg:#f4efe7; --card:#ffffff; --text:#1e1b16; --muted:#6b645a; --brand:#b23a12; --accent:#ffd25a; --border:#e6ded0;}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,"Noto Sans Devanagari","Hind",sans-serif;background:var(--bg);color:var(--text);}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,var(--card),rgba(0,0,0,0));border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;gap:10px;}
  header h1{font-size:18px;margin:0;color:var(--brand)}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto} nav button{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:14px;cursor:pointer}
  nav button.active{background:var(--brand);color:#fff;border-color:var(--brand)} .container{max-width:980px;margin:14px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,0.12)} .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
  .searchbar{display:flex;gap:8px;margin:8px 0 12px} input[type="text"],input[type="number"],input[type="time"]{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
  textarea{width:100%;min-height:120px;padding:10px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);white-space:pre-wrap}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(255,107,0,0.1);border:1px solid var(--border);color:var(--brand);font-size:12px}
  .list-item{padding:10px;border:1px solid var(--border);border-radius:12px} .muted{color:var(--muted);font-size:12px} .footer{text-align:center;padding:16px;color:var(--muted)}
  .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer} .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px} audio{width:100%;margin-top:8px} .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<header><div class="row"><img src="icons/icon-192.png" width="28" height="28" style="border-radius:8px"><h1>Mandir Community</h1></div>
  <nav>
    <button data-tab="home" class="active">Home</button>
    <button data-tab="aartis">Aarti 100</button>
    <button data-tab="bhajans">Bhajan 100</button>
    <button data-tab="donate">Donate</button>
    <button data-tab="community">Community</button>
    <button data-tab="panchang">Panchang</button>
    <button data-tab="wall">Donor Wall</button>
    <button data-tab="settings">Settings</button>
  </nav>
</header>
<div class="container">
  <div id="home" class="card">
    <div class="row" style="justify-content:space-between">
      <div><h2 style="margin:0 0 6px">‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à üôè</h2><div class="muted">‡§Ø‡§π ‡§ê‡§™ PWA ‡§π‡•à‚Äî‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§ñ‡•Å‡§≤‡§§‡•á ‡§π‡•Ä ‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§ï‡•à‡§∂ ‡§¨‡§® ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§</div></div>
      <div class="row"><span class="muted">Theme</span>
        <select id="themeSelect" class="btn"><option value="dark">Dark</option><option value="light">Light</option><option value="saffron">Saffron</option><option value="classic">Classic</option></select>
      </div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div class="card"><div class="pill">‡§Ü‡§∞‡§§‡•Ä</div><h3>100 ‡§Ü‡§∞‡§§‡§ø‡§Ø‡§æ‡§Å</h3><p class="muted">‡§¶‡•á‡§µ‡§®‡§æ‡§ó‡§∞‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü + ‡§ë‡§°‡§ø‡§Ø‡•ã</p><button class="btn primary" onclick="switchTab('aartis')">‡§ñ‡•ã‡§≤‡•á‡§Ç</button></div>
      <div class="card"><div class="pill">‡§≠‡§ú‡§®</div><h3>100 ‡§≠‡§ú‡§®</h3><p class="muted">‡§∏‡§∞‡•ç‡§ö + ‡§™‡•á‡§ú‡§ø‡§®‡•á‡§∂‡§®</p><button class="btn primary" onclick="switchTab('bhajans')">‡§ñ‡•ã‡§≤‡•á‡§Ç</button></div>
      <div class="card"><div class="pill">‡§¶‡§æ‡§®</div><h3>‡§¶‡§æ‡§® ‡§´‡§º‡•â‡§∞‡•ç‡§Æ</h3><p class="muted">‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø, CSV ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§</p><button class="btn" onclick="switchTab('donate')">‡§ú‡§æ‡§è‡§Å</button></div>
      <div class="card"><div class="pill">‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä</div><h3>‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</h3><p class="muted">‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§® ‡§™‡•ã‡§∏‡•ç‡§ü, ‡§è‡§°‡§Æ‡§ø‡§® ‡§°‡§ø‡§≤‡•Ä‡§ü</p><button class="btn" onclick="switchTab('community')">‡§ú‡§æ‡§è‡§Å</button></div>
      <div class="card"><div class="pill">‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó</div><h3>‡§Ü‡§ú ‡§ï‡§æ ‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó</h3><p class="muted">‡§ë‡§´‡§≤‡§æ‡§á‡§® JSON ‡§°‡•á‡§ü‡§æ</p><button class="btn" onclick="switchTab('panchang')">‡§¶‡•á‡§ñ‡•á‡§Ç</button></div>
    </div>
  </div>

  <div id="aartis" class="card" style="display:none"><h2>‡§Ü‡§∞‡§§‡•Ä (100)</h2>
    <div class="searchbar"><input id="searchAarti" type="text" placeholder="‡§Ü‡§∞‡§§‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç..."></div>
    <div id="aartiList" class="grid"></div>
    <div class="pager"><button class="btn" id="a_prev">‡§™‡§ø‡§õ‡§≤‡§æ</button><span class="muted" id="a_page"></span><button class="btn" id="a_next">‡§Ö‡§ó‡§≤‡§æ</button></div>
  </div>

  <div id="bhajans" class="card" style="display:none"><h2>‡§≠‡§ú‡§® (100)</h2>
    <div class="searchbar"><input id="searchBhajan" type="text" placeholder="‡§≠‡§ú‡§® ‡§ñ‡•ã‡§ú‡•á‡§Ç..."></div>
    <div id="bhajanList" class="grid"></div>
    <div class="pager"><button class="btn" id="b_prev">‡§™‡§ø‡§õ‡§≤‡§æ</button><span class="muted" id="b_page"></span><button class="btn" id="b_next">‡§Ö‡§ó‡§≤‡§æ</button></div>
  </div>

  <div id="donate" class="card" style="display:none"><h2>‡§¶‡§æ‡§® ‡§´‡§º‡•â‡§∞‡•ç‡§Æ</h2>
    <form id="donationForm">
      <div class="grid" style="grid-template-columns: repeat(auto-fill,minmax(200px,1fr));">
        <div><label>‡§®‡§æ‡§Æ</label><input name="name" type="text" required></div>
        <div><label>‡§∞‡§æ‡§∂‡§ø (‚Çπ)</label><input name="amount" type="number" min="1" step="1" required></div>
        <div><label>‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label><input name="phone" type="text" placeholder="‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï"></div>
      </div>
      <div style="margin-top:8px;"><label>‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä</label><textarea name="note" placeholder="‡§â‡§¶‡•ç‡§¶‡•á‡§∂‡•ç‡§Ø/‡§®‡•ç‡§Ø‡§æ‡§∏ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)"></textarea></div>
      <div class="row" style="margin-top:10px"><button class="btn primary" type="submit">‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</button><button class="btn" type="button" onclick="clearForm()">‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button></div>
    </form>
    <div class="muted" id="donationThanks" style="display:none;margin-top:8px;">‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§Ü‡§™‡§ï‡•Ä ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§</div>
    <h3 style="margin-top:14px;">‡§§‡§æ‡§ú‡§º‡§æ ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø‡§Ø‡§æ‡§Å</h3><div id="recentDonations" class="grid"></div>
  </div>

  <div id="community" class="card" style="display:none"><h2>‡§ï‡§Æ‡•ç‡§Ø‡•Å‡§®‡§ø‡§ü‡•Ä</h2>
    <form id="postForm">
      <div class="grid" style="grid-template-columns: repeat(auto-fill,minmax(200px,1fr));">
        <div><label>‡§®‡§æ‡§Æ</label><input name="name" type="text" required></div>
        <div><label>‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï</label><input name="title" type="text" required></div>
      </div>
      <div style="margin-top:8px;"><label>‡§∏‡§Ç‡§¶‡•á‡§∂</label><textarea name="message" placeholder="‡§Ö‡§™‡§®‡§æ ‡§∏‡•Å‡§ù‡§æ‡§µ/‡§Ö‡§®‡•Å‡§≠‡§µ ‡§≤‡§ø‡§ñ‡•á‡§Ç..." required></textarea></div>
      <div class="row" style="margin-top:10px"><button class="btn primary" type="submit">‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button><button class="btn" type="button" onclick="clearPostForm()">‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button></div>
    </form>
    <h3 style="margin-top:14px;">‡§π‡§æ‡§≤ ‡§ï‡•Ä ‡§™‡•ã‡§∏‡•ç‡§ü‡•á‡§Ç</h3><div id="postList" class="grid"></div>
  </div>

  <div id="panchang" class="card" style="display:none"><h2>‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó (2025)</h2>
    <div class="row" style="gap:6px"><input type="date" id="panchangDate"><button class="btn" onclick="showToday()">‡§Ü‡§ú</button></div>
    <div id="panchangView" class="card" style="margin-top:10px"></div>
    <div class="muted" style="margin-top:8px">‡§®‡•ã‡§ü: ‡§Ø‡§π ‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§°‡§æ‡§ü‡§æ ‡§π‡•à; ‡§Ö‡§ß‡§ø‡§ï ‡§§‡§ø‡§•‡§ø‡§Ø‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è <code>data/panchang_2025.json</code> ‡§Æ‡•á‡§Ç ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä‡§ú‡§º ‡§¨‡§¢‡§º‡§æ‡§è‡§Å‡•§</div>
  </div>

  <div id="wall" class="card" style="display:none"><h2>‡§°‡•ã‡§®‡§∞ ‡§µ‡•â‡§≤</h2>
    <div id="donorStats" class="card" style="background:rgba(255,107,0,0.1)"></div>
    <div id="donorWall" class="grid" style="margin-top:10px"></div>
    <button class="btn" onclick="exportCSV()">CSV ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
  </div>

  <div id="settings" class="card" style="display:none"><h2>‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</h2>
    <h3>‡§•‡•Ä‡§Æ</h3><div class="row">
      <button class="btn" onclick="applyTheme('dark')">Dark</button>
      <button class="btn" onclick="applyTheme('light')">Light</button>
      <button class="btn" onclick="applyTheme('saffron')">Saffron</button>
      <button class="btn" onclick="applyTheme('classic')">Classic</button>
    </div>
    <hr><h3>‡§¶‡•à‡§®‡§ø‡§ï ‡§∞‡§ø‡§Æ‡§æ‡§á‡§Ç‡§°‡§∞</h3>
    <div class="grid" style="grid-template-columns: repeat(auto-fill,minmax(200px,1fr));">
      <div><label>‡§∏‡•Å‡§¨‡§π ‡§Ü‡§∞‡§§‡•Ä</label><input id="timeMorning" type="time" value="06:30"></div>
      <div><label>‡§∂‡§æ‡§Æ ‡§Ü‡§∞‡§§‡•Ä</label><input id="timeEvening" type="time" value="19:00"></div>
    </div>
    <div class="row" style="margin-top:10px"><button class="btn" onclick="saveReminderTimes()">‡§∏‡•á‡§µ</button><button class="btn" onclick="testReminder()">‡§ü‡•á‡§∏‡•ç‡§ü</button></div>
    <hr><h3>‡§è‡§°‡§Æ‡§ø‡§®</h3>
    <div class="grid" style="grid-template-columns: repeat(auto-fill,minmax(200px,1fr));"><div><label>‡§è‡§°‡§Æ‡§ø‡§® PIN</label><input id="adminPin" type="text" placeholder="‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü: 1080"></div></div>
    <div class="row" style="margin-top:10px"><button class="btn" onclick="toggleAdmin()">‡§è‡§°‡§Æ‡§ø‡§® ‡§Æ‡•ã‡§°</button><button class="btn" onclick="resetAll()">‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button></div>
    <div id="adminArea" style="display:none; margin-top:12px;"><h4>‡§∏‡§≠‡•Ä ‡§¶‡§æ‡§® ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø‡§Ø‡§æ‡§Å</h4><div id="adminList" class="grid"></div></div>
  </div>
  <div class="footer">¬© Mandir Community ‚Ä¢ Offline PWA</div>
</div>

<script>
const root=document.documentElement;
function applyTheme(t){ localStorage.setItem('theme', t); root.setAttribute('data-theme', t==='dark'?'':t); }
(function(){ const t=localStorage.getItem('theme')||'dark'; document.getElementById('themeSelect').value=t; applyTheme(t); })();
document.getElementById('themeSelect').addEventListener('change', e=> applyTheme(e.target.value));

const tabs=document.querySelectorAll('nav button');
tabs.forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
function switchTab(id){
  tabs.forEach(b=>b.classList.remove('active'));
  document.querySelector(`nav button[data-tab="${id}"]`)?.classList.add('active');
  ['home','aartis','bhajans','donate','community','panchang','wall','settings'].forEach(x=>document.getElementById(x).style.display = x===id?'block':'none');
  if(id==='aartis') renderAartis(); if(id==='bhajans') renderBhajans(); if(id==='community') renderPosts();
  if(id==='panchang') loadPanchang(); if(id==='wall') renderWall(); if(id==='settings') loadReminderTimes();
  history.replaceState(null,'','#'+id);
}
if(location.hash) switchTab(location.hash.substring(1));

let AARTIS=[], BHAJANS=[];
fetch('data/aartis.json').then(r=>r.json()).then(j=>{AARTIS=j;});
fetch('data/bhajans.json').then(r=>r.json()).then(j=>{BHAJANS=j;});

const PER_PAGE=12; let aPage=1, bPage=1, aFiltered=()=>AARTIS, bFiltered=()=>BHAJANS;
document.getElementById('searchAarti').addEventListener('input',(e)=>{const q=e.target.value.trim().toLowerCase(); aFiltered=()=>AARTIS.filter(x=>x.title.toLowerCase().includes(q)||x.lyrics.toLowerCase().includes(q)); aPage=1; renderAartis();});
document.getElementById('searchBhajan').addEventListener('input',(e)=>{const q=e.target.value.trim().toLowerCase(); bFiltered=()=>BHAJANS.filter(x=>x.title.toLowerCase().includes(q)||x.lyrics.toLowerCase().includes(q)); bPage=1; renderBhajans();});

function mkItemCard(item, type){
  const el=document.createElement('div'); el.className='list-item';
  const audioName=(type==='aarti'?'aarti':'bhajan')+'_'+item.id.split('_').pop()+'.wav';
  el.innerHTML = `<div class="pill">${type==='aarti'?'‡§Ü‡§∞‡§§‡•Ä':'‡§≠‡§ú‡§®'}</div><h3>${item.title}</h3>
                  <textarea readonly>${item.lyrics}</textarea><audio controls src="assets/audio/${audioName}"></audio>`;
  return el;
}
function bindPager(prefix, page, total, onPrev, onNext){
  document.getElementById(prefix+'_page').textContent=`‡§™‡•É‡§∑‡•ç‡§† ${page} / ${Math.max(1, Math.ceil(total/PER_PAGE))}`;
  document.getElementById(prefix+'_prev').onclick=()=>{if(page>1) onPrev();};
  document.getElementById(prefix+'_next').onclick=()=>{if(page*PER_PAGE<total) onNext();};
}
function renderAartis(){ const list=aFiltered(); const rootEl=document.getElementById('aartiList'); rootEl.innerHTML='';
  list.slice((aPage-1)*PER_PAGE,(aPage-1)*PER_PAGE+PER_PAGE).forEach(x=>rootEl.appendChild(mkItemCard(x,'aarti')));
  if(!list.length) rootEl.innerHTML='<div class="muted">‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>'; bindPager('a', aPage, list.length, ()=>{aPage--; renderAartis();}, ()=>{aPage++; renderAartis();}); }
function renderBhajans(){ const list=bFiltered(); const rootEl=document.getElementById('bhajanList'); rootEl.innerHTML='';
  list.slice((bPage-1)*PER_PAGE,(bPage-1)*PER_PAGE+PER_PAGE).forEach(x=>rootEl.appendChild(mkItemCard(x,'bhajan')));
  if(!list.length) rootEl.innerHTML='<div class="muted">‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>'; bindPager('b', bPage, list.length, ()=>{bPage--; renderBhajans();}, ()=>{bPage++; renderBhajans();}); }

// Donations
const KEY_DON='mandir_donations_v1';
function loadDonations(){ try{return JSON.parse(localStorage.getItem(KEY_DON)||'[]');}catch{return []} }
function saveDonations(arr){ localStorage.setItem(KEY_DON, JSON.stringify(arr)); }
function addDonation(d){ const arr=loadDonations(); arr.unshift(Object.assign({id:Date.now()}, d)); saveDonations(arr); renderRecent(); }
function deleteDonation(id){ saveDonations(loadDonations().filter(x=>x.id!==id)); renderRecent(); renderWall(); renderAdminList(); }
const form=document.getElementById('donationForm');
form.addEventListener('submit',(e)=>{ e.preventDefault(); const data=Object.fromEntries(new FormData(form).entries());
  const amount=parseInt(data.amount,10); if(!data.name || !amount || amount<=0) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§∏‡§π‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§≠‡§∞‡•á‡§Ç');
  addDonation({ name:data.name.trim(), amount, phone:data.phone?.trim()||'', note:data.note?.trim()||'' });
  document.getElementById('donationThanks').style.display='block'; setTimeout(()=>document.getElementById('donationThanks').style.display='none', 2000); form.reset(); });
function clearForm(){ form.reset(); }
function renderRecent(){ const root=document.getElementById('recentDonations'); root.innerHTML='';
  loadDonations().slice(0,6).forEach(d=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<b>${d.name}</b><div class="muted">‚Çπ ${d.amount}</div><div class="muted">${d.note||''}</div>`; root.appendChild(el); }); }
renderRecent();
function renderWall(){ const root=document.getElementById('donorWall'); root.innerHTML=''; const data=loadDonations();
  const total=data.reduce((s,x)=>s+(parseInt(x.amount,10)||0),0);
  document.getElementById('donorStats').innerHTML=`‡§ï‡•Å‡§≤ ‡§¶‡§æ‡§®: <b>‚Çπ ${total}</b> ‚Ä¢ ‡§ï‡•Å‡§≤ ‡§¶‡§æ‡§§‡§æ: <b>${data.length}</b>`;
  data.forEach(d=>{ const el=document.createElement('div'); el.className='list-item'; el.innerHTML=`<b>${d.name}</b><div class="muted">‚Çπ ${d.amount}</div><div class="muted">${d.note||''}</div>`; root.appendChild(el); });
  if(!data.length) root.innerHTML='<div class="muted">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§®‡§π‡•Ä‡§Ç‡•§</div>'; }
function exportCSV(){ const rows=[['Name','Amount','Phone','Note','Timestamp']]; loadDonations().forEach(d=>rows.push([d.name,d.amount,d.phone||'',d.note||'',new Date(d.id).toISOString()]));
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='donations.csv'; a.click(); }
// Admin
const PIN_DEFAULT='1080'; let adminOn=false;
function toggleAdmin(){ const pin=document.getElementById('adminPin').value||PIN_DEFAULT;
  if(pin===(localStorage.getItem('admin_pin')||PIN_DEFAULT)){ adminOn=!adminOn; document.getElementById('adminArea').style.display=adminOn?'block':'none'; if(adminOn) renderAdminList(); } else alert('‡§ó‡§≤‡§§ PIN'); }
function renderAdminList(){ const root=document.getElementById('adminList'); root.innerHTML='';
  loadDonations().forEach(d=>{ const el=document.createElement('div'); el.className='list-item'; el.innerHTML=`<b>${d.name}</b> ‚Äî ‚Çπ ${d.amount} <button class="btn" style="float:right" onclick="deleteDonation(${d.id})">‡§π‡§ü‡§æ‡§è‡§Å</button><div class="muted">${d.note||''}</div>`; root.appendChild(el); });
  if(!loadDonations().length) root.innerHTML='<div class="muted">‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§®‡§π‡•Ä‡§Ç‡•§</div>'; }
function resetAll(){ if(confirm('‡§∏‡§æ‡§∞‡§æ ‡§≤‡•ã‡§ï‡§≤ ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§ü‡§æ‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ?')){ localStorage.clear(); renderRecent(); renderWall(); document.getElementById('adminArea').style.display='none'; } }

// Community
const KEY_POST='mandir_posts_v1';
function loadPosts(){ try{return JSON.parse(localStorage.getItem(KEY_POST)||'[]');}catch{return []} }
function savePosts(arr){ localStorage.setItem(KEY_POST, JSON.stringify(arr)); }
function addPost(p){ const arr=loadPosts(); arr.unshift(Object.assign({id:Date.now()}, p)); savePosts(arr); renderPosts(); }
function deletePost(id){ savePosts(loadPosts().filter(x=>x.id!==id)); renderPosts(); }
const postForm=document.getElementById('postForm');
postForm.addEventListener('submit',(e)=>{ e.preventDefault(); const data=Object.fromEntries(new FormData(postForm).entries());
  if(!data.name || !data.title || !data.message) return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ/‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï/‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≠‡§∞‡•á‡§Ç');
  addPost({ name:data.name.trim(), title:data.title.trim(), message:data.message.trim() }); postForm.reset(); });
function clearPostForm(){ postForm.reset(); }
function renderPosts(){ const root=document.getElementById('postList'); root.innerHTML=''; const posts=loadPosts();
  posts.forEach(p=>{ const el=document.createElement('div'); el.className='list-item';
    el.innerHTML = `<div class="row" style="justify-content:space-between"><div><b>${p.title}</b><div class="muted">by ${p.name}</div></div><div class="muted">${new Date(p.id).toLocaleString()}</div></div>
                    <div style="margin-top:6px">${p.message.replace(/</g,'&lt;')}</div>
                    <div class="row" style="justify-content:flex-end; margin-top:6px"><button class="btn" onclick="deletePost(${p.id})">‡§π‡§ü‡§æ‡§è‡§Å</button></div>`; root.appendChild(el); });
  if(!posts.length) root.innerHTML='<div class="muted">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§™‡•ã‡§∏‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç‡•§</div>'; }

// Panchang
let P25=null;
function loadPanchang(){ if(P25) return; fetch('data/panchang_2025.json').then(r=>r.json()).then(j=>{P25=j; showToday();}); }
function showToday(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const iso=`${y}-${m}-${dd}`; document.getElementById('panchangDate').value=iso; renderPanchang(iso); }
document.getElementById('panchangDate').addEventListener('change',(e)=>renderPanchang(e.target.value));
function renderPanchang(iso){ if(!P25){ document.getElementById('panchangView').textContent='‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...'; return; }
  const rec=(P25.entries||[]).find(x=>x.date===iso); const box=document.getElementById('panchangView');
  if(!rec){ box.innerHTML=`<b>${iso}</b><div class="muted">‡§á‡§∏ ‡§§‡§ø‡§•‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ data/panchang_2025.json ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç‡•§</div>`; return; }
  box.innerHTML = `<h3 style="margin:0 0 6px">${iso}</h3>
                   <div class="grid" style="grid-template-columns: repeat(auto-fill,minmax(180px,1fr));">
                     <div class="list-item"><b>‡§§‡§ø‡§•‡§ø</b><div>${rec.tithi}</div></div>
                     <div class="list-item"><b>‡§™‡§ï‡•ç‡§∑</b><div>${rec.paksha}</div></div>
                     <div class="list-item"><b>‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞</b><div>${rec.nakshatra}</div></div>
                     <div class="list-item"><b>‡§™‡§∞‡•ç‡§µ</b><div>${rec.festival||'-'}</div></div>
                   </div>`; }

// Reminders
function loadReminderTimes(){ const val=JSON.parse(localStorage.getItem('rem_times')||'{}'); if(val.morning) document.getElementById('timeMorning').value=val.morning; if(val.evening) document.getElementById('timeEvening').value=val.evening; }
function saveReminderTimes(){ const obj={ morning:document.getElementById('timeMorning').value, evening:document.getElementById('timeEvening').value }; localStorage.setItem('rem_times', JSON.stringify(obj)); alert('‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ'); }
function showInAppNotification(msg){ const div=document.createElement('div'); div.className='card'; div.style.background='rgba(255,107,0,0.12)'; div.textContent=msg; document.querySelector('.container').prepend(div); setTimeout(()=>div.remove(), 4000); }
function testReminder(){ showInAppNotification('‡§ü‡•á‡§∏‡•ç‡§ü: ‡§Ü‡§∞‡§§‡•Ä ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§π‡•Å‡§Ü‡•§'); }
setInterval(()=>{ const val=JSON.parse(localStorage.getItem('rem_times')||'{}'); const now=new Date(); const hh=String(now.getHours()).padStart(2,'0'); const mm=String(now.getMinutes()).padStart(2,'0'); const cur=hh+':'+mm;
  if(val.morning && cur===val.morning) showInAppNotification('‡§∏‡•Å‡§¨‡§π ‡§Ü‡§∞‡§§‡•Ä ‡§ï‡§æ ‡§∏‡§Æ‡§Ø‡•§'); if(val.evening && cur===val.evening) showInAppNotification('‡§∂‡§æ‡§Æ ‡§Ü‡§∞‡§§‡•Ä ‡§ï‡§æ ‡§∏‡§Æ‡§Ø‡•§'); }, 60000);

// PWA
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }
</script>
</body></html>